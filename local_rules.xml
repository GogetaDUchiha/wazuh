<!-- Local rules for detecting specific system and security events -->

<!-- Group: Local SSHD logins -->
<group name="local,syslog,sshd,">
  <!-- Rule: Detects SSH authentication failure from IP 1.1.1.1 -->
  <rule id="100001" level="5">
    <if_sid>5716</if_sid>
    <srcip>1.1.1.1</srcip>
    <description>sshd: authentication failed from IP 1.1.1.1.</description>
    <group>authentication_failed,pci_dss_10.2.4,pci_dss_10.2.5,</group>
  </rule>
</group>

<!-- Group: Syscheck integration with VirusTotal -->
<group name="syscheck,virustotal">
  <!-- Rule: Detects EICAR file via Windows Defender and sends to VirusTotal -->
  <rule id="100200" level="12">
    <if_sid>60603</if_sid>
    <field name="win.eventdata.threatName">EICAR</field>
    <description>Windows Defender detected EICAR file. Sending to VirusTotal.</description>
    <group>virustotal</group>
  </rule>
</group>

<!-- Group: Windows malware and suspicious activity detection -->
<group name="windows,malware,">

  <!-- Rule: Detects Meterpreter or reverse TCP shell activity -->
  <rule id="100100" level="12">
    <if_sid>60000</if_sid>
    <regex type="pcre2">(?i)meterpreter|reverse_tcp</regex>
    <description>Meterpreter/Reverse TCP activity detected: $(win.eventdata.image)</description>
    <group>malware,threat,connection_attempt</group>
    <mitre>
      <id>T1059.001</id>
      <id>T1071.001</id>
      <id>T1090.001</id>
      <id>T1021.001</id>
      <id>T1569.002</id>
    </mitre>
  </rule>

  <!-- Rule: Suspicious process creation from suspicious parent process -->
  <rule id="100101" level="10">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.eventID">4688</field>
    <description>Windows: Suspicious process creation chain. Parent: $(win.eventdata.parentProcessName) Child: $(win.eventdata.newProcessName)</description>
    <group>process_creation,suspicious_activity,malware</group>
    <mitre>
      <id>T1059</id>
      <id>T1053</id>
      <id>T1543</id>
    </mitre>
    <decoded_as>windows</decoded_as>
    <field name="win.eventdata.parentProcessName" type="pcre2">(?i)(cmd\.exe|powershell\.exe|wscript\.exe|cscript\.exe|mshta\.exe|rundll32\.exe|explorer\.exe)$</field>
    <field name="win.eventdata.newProcessName" type="pcre2">(?i)(cmd\.exe|powershell\.exe|bitsadmin\.exe|certutil\.exe|mshta\.exe|regsvr32\.exe|rundll32\.exe|svchost\.exe|wscript\.exe|cscript\.exe|msiexec\.exe|ftp\.exe|schtasks\.exe|pwsh\.exe)$</field>
    <options>no_full_log</options>
    <field name="win.eventdata.commandLine" type="pcre2" negate="yes">(?i)(/c "C:\\Program Files\\.*"|/k "C:\\Program Files\\.*")</field>
  </rule>

  <!-- Rule: Executable launched from an unusual file path -->
  <rule id="100102" level="10">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.eventID">4688</field>
    <description>Windows: Executable started from unusual path: $(win.eventdata.newProcessName)</description>
    <group>malware,process_execution,unusual_location</group>
    <mitre>
      <id>T1036.005</id>
      <id>T1202</id>
    </mitre>
    <decoded_as>windows</decoded_as>
    <field name="win.eventdata.newProcessName" type="pcre2">(?i)\.(exe|dll|vbs|ps1|js|hta|wsf)$</field>
    <regex type="pcre2" negate="yes">(?i)^(C:\\Windows\\(System32|SysWOW64|Temp|Installer|IME)|C:\\Program Files( \(x86\))?|C:\\ProgramData\\Microsoft\\Windows Defender\\Definition Updates|C:\\Users\\(Public|Default|All Users)\\|^C:\\ProgramData\\Microsoft\\Windows\\Start Menu\\Programs\\Startup)</regex>
    <options>no_full_log</options>
  </rule>

  <!-- Rule: Suspicious network connection by system process -->
  <rule id="100103" level="12">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.eventID">3</field>
    <description>Windows: Suspicious network connection by system process: $(win.eventdata.image) to $(win.eventdata.destinationIp)</description>
    <group>malware,network_connection,suspicious_activity</group>
    <mitre>
      <id>T1071.001</id>
      <id>T1041</id>
      <id>T1573</id>
    </mitre>
    <decoded_as>windows</decoded_as>
    <field name="win.eventdata.image" type="pcre2">(?i)(svchost\.exe|lsass\.exe|winlogon\.exe|services\.exe|explorer\.exe|dllhost\.exe|spoolsv\.exe|powershell\.exe|cmd\.exe)</field>
    <field name="win.eventdata.destinationIp" type="pcre2" negate="yes">^(10\.|172\.16\.|192\.168\.|127\.|0\.0\.0\.0)</field>
    <field name="win.eventdata.destinationPort" type="pcre2" negate="yes">^(80|443|53)</field>
    <options>no_full_log</options>
  </rule>

  <!-- Rule: Obfuscated PowerShell command execution -->
  <rule id="100104" level="10">
    <if_sid>60000</if_sid>
    <field name="win.eventdata.eventID">4688</field>
    <field name="win.eventdata.newProcessName" type="pcre2">(?i)powershell\.exe|pwsh\.exe</field>
    <description>Windows: Obfuscated PowerShell command execution detected: $(win.eventdata.commandLine)</description>
    <group>powershell,obfuscation,malware,threat</group>
    <mitre>
      <id>T1059.001</id>
      <id>T1027</id>
    </mitre>
    <decoded_as>windows</decoded_as>
    <regex type="pcre2">(?i)(EncodedCommand|EncC|FromBase64String|New-Object System.Net.WebClient|IEX|Invoke-Expression|DownloadString|System\.Reflection\.Assembly\.Load)</regex>
    <options>no_full_log</options>
  </rule>
</group>
